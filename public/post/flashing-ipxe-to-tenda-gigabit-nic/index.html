<!DOCTYPE html>
<html lang="en-us">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=51372&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reverse Engineering and Flashing iPXE to Tenda Gigabit NIC · x86sec</title>

  <meta name="description" content="Vulnerability research, kernel exploitation, and reverse engineering.">
  <meta name="author" content="Grant Foudree">

  
  <meta property="og:title" content="Reverse Engineering and Flashing iPXE to Tenda Gigabit NIC">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://localhost:51372/post/flashing-ipxe-to-tenda-gigabit-nic/">

  
  <link rel="canonical" href="http://localhost:51372/post/flashing-ipxe-to-tenda-gigabit-nic/">
  <link rel="alternate" type="application/rss+xml" title="x86sec" href="http://localhost:51372/index.xml">

  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/css/main.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body><header class="site-header">
  <div class="container">
    <a class="site-logo" href="/" data-text="[x86sec]"><span class="bracket">[</span>x86sec<span class="bracket">]</span></a>
    <nav class="site-nav">
      
      <a href="/"
         class="active">
        posts
      </a>
      
      <a href="/about/"
         class="">
        about
      </a>
      
    </nav>
  </div>
</header>
<main>
<div class="container">

  
  <div class="page-hero">
    <h1>Reverse Engineering and Flashing iPXE to Tenda Gigabit NIC</h1>
    
    <div class="hero-meta">
      <span><span class="dot">date</span> April 25, 2024</span>
      
      <span><span class="dot">read</span> 18 min</span>
      
      <span>
        
        <a href="/tags/ipxe" class="tag">iPXE</a>
        
        <a href="/tags/oprom" class="tag">oprom</a>
        
        <a href="/tags/option-rom" class="tag">option rom</a>
        
        <a href="/tags/pxe" class="tag">PXE</a>
        
        <a href="/tags/flash" class="tag">flash</a>
        
        <a href="/tags/nic" class="tag">NIC</a>
        
      </span>
      
    </div>
    
  </div>

  
  <div class="post-content">
    <article class="prose">
      <h2 id="tenda-gigabit-nic-and-pxe-booting">Tenda Gigabit NIC and PXE booting</h2>
<p>I had a Tenda Gigabit NIC laying around and noticed it contained 2 chips on it which looked to be like EEPROM and flash chips and was curious on what I could do with them. It is common for NICs to contain an option rom (OPROM) which runs during boot allowing the user to PXE boot an operating system. Usually these OPROMs are proprietary programs and can&rsquo;t be hacked to support additional features beyond standard booting, but there is an open-source project <a href="https://ipxe.org/">iPXE</a> which supports lots of additional features.</p>
<p>In this post, I will show you how to extract the stock firmware and EEPROM from the card, and how to replace it with iPXE.</p>
<h2 id="ipxe">iPXE</h2>
<p><a href="https://ipxe.org/">iPXE</a> is an open-source network boot firmware which contains lots of features such as scriptable PXE booting, booting from multiple protocols (HTTP, HTTPS, iSCSI, and more). This is great as not everyone wants to setup a TFTP server to perform traditional PXE booting, and the <a href="https://ipxe.org/scripting">scripting feature</a> is amazing.</p>
<p>iPXE can be configured to be chain-loaded, meaning traditional PXE OPROMs can boot and load iPXE from the server which then takes over. This is the easiest option, but let&rsquo;s take a peek into how to burn the OPROM directly onto the card, speeding this up.</p>
<h2 id="inspecting-the-board">Inspecting the Board</h2>
<p><img src="/tenda_nic_chips_closeup.webp" alt="TPM PCR registers"></p>
<p>Looking closely, there are 3 main chips of interest:</p>
<ul>
<li>NIC controller: RTL8168E</li>
<li>Flash chip: AH1445 25Q40BT</li>
<li>EEPROM chip: FM93C46</li>
</ul>
<h2 id="nic-controller">NIC Controller</h2>
<p>The NIC is a RTL8168E Realtek 1G chip. From the <a href="https://www.alldatasheet.com/datasheet-pdf/pdf/144204/ETC1/RTL8168.html">datasheet</a> we can see that it supports an OPROM as well as various configurable values (MAC address, etc&hellip;) and it seems to be well documented.</p>
<h2 id="eeprom">EEPROM</h2>
<p>Usually EEPROM is used to store some sort of configuration (that can be modified) for embedded systems. Looking at the <a href="https://web.archive.org/web/20240425171756/https://www.farnell.com/datasheets/7431.pdf">datasheet</a> for it, we can see that it is a 1024-<em>Bit</em> EEPROM organized as a 64 x 16 <em>bit</em> array so a total of 128 <em>bytes</em>. This is way too small for an OPROM, so we will assume this is for configuration and not the PXE booting ROM.</p>
<h2 id="flash">Flash</h2>
<p>From the <a href="https://www.hmsemi.com/index.php/Down/down/id/1461.html">datasheet</a>, we can see it is a 128 Mbit 3v SPI/QSPI serial flash chip which has some security features like write protection and a unique ID. This is much larger than the EEPROM and where I would suspect the PXE ROM to be located.</p>
<h2 id="trying-to-read-the-eeprom">Trying to read the EEPROM</h2>
<h2 id="software-approach">Software Approach</h2>
<p>The easiest way is to use <code>ethtool</code> to dump the EEPROM contents. This works on some NICs, but not on this one&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>└─# ethtool -e eth0
</span></span><span style="display:flex;"><span>Cannot get EEPROM data: Operation not supported
</span></span></code></pre></div><p>It seems like the NICs you can dump the EEPROM on are ones that support this IOCTL command in their driver. I noticed that the driver automatically loaded by Linux was not the specific/official driver for RTL8168E so I decided to look at <a href="https://github.com/mtorromeo/r8168">Realtek&rsquo;s offical driver</a> to see if it implemented this IOCTL command.</p>
<p>Poking around, I saw that <a href="https://github.com/mtorromeo/r8168/blob/503086686ea7b08b8b9b323ab52991987dfd9f6a/src/r8168_n.c#L27496">it <em>did</em>!</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ethtool_ioctl</span>(<span style="color:#66d9ef">struct</span> ifreq <span style="color:#f92672">*</span>ifr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> net_device <span style="color:#f92672">*</span>dev <span style="color:#f92672">=</span> <span style="color:#a6e22e">__dev_get_by_name</span>(ifr<span style="color:#f92672">-&gt;</span>ifr_name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>useraddr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) ifr<span style="color:#f92672">-&gt;</span>ifr_data;
</span></span><span style="display:flex;"><span>        u32 ethcmd;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       ...
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> ETHTOOL_GEEPROM:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ethtool_get_eeprom</span>(dev, useraddr);
</span></span></code></pre></div><p>After building and loading it (had to unload the existing Linux driver first), I was able to dump the EEPROM. Fantastic!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>┌──<span style="color:#f92672">(</span>gfoudree㉿nzxt-desktop<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/tmp/r8168-8.052.01<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└─$ sudo ethtool -e enp6s0
</span></span><span style="display:flex;"><span>Offset		Values
</span></span><span style="display:flex;"><span>------		------
</span></span><span style="display:flex;"><span>0x0000:		<span style="color:#ae81ff">29</span> <span style="color:#ae81ff">81</span> ec <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">81</span> ec <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">01</span> 1c <span style="color:#ae81ff">60</span> c8 3a 
</span></span><span style="display:flex;"><span>0x0010:		<span style="color:#ae81ff">35</span> d2 <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">97</span> <span style="color:#ae81ff">05</span> 0f c3 ff <span style="color:#ae81ff">54</span> 8a c0 8c <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>0x0020:		<span style="color:#ae81ff">11</span> 3c <span style="color:#ae81ff">07</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">01</span> ff <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">13</span> aa <span style="color:#ae81ff">03</span> 
</span></span><span style="display:flex;"><span>0x0030:		<span style="color:#ae81ff">02</span> <span style="color:#ae81ff">20</span> 4a <span style="color:#ae81ff">19</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">20</span> 3f 
</span></span><span style="display:flex;"><span>0x0040:		<span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> b9 6a <span style="color:#ae81ff">98</span> <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">00</span> 0a <span style="color:#ae81ff">00</span> e0 <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">68</span> 4c <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>0x0050:		<span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> ac 6b <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">80</span> 8d <span style="color:#ae81ff">75</span> 7b <span style="color:#ae81ff">01</span> a9 c0 <span style="color:#ae81ff">48</span> <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>0x0060:		<span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>0x0070:		<span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 
</span></span></code></pre></div><p>Unfortunately this data seems rather uninteresting. There are no strings and from the RTL8168E datasheet it looks like the main things stored here are the MAC address, PCI configuration and a RTL8168 configuration register (important later). The full details can be found in the <a href="https://pdf1.alldatasheet.com/datasheet-pdf/download/144204/ETC1/RTL8168.html">datasheet</a></p>
<p><img src="/eeprom-datasheet-realtek.webp" alt="EEPROM Fields"></p>
<h2 id="trying-to-read-the-flash">Trying to read the flash</h2>
<p>The flash is a bit trickier, ethtool doesn&rsquo;t support dumping it even with the Realtek driver. <a href="https://www.flashrom.org/">Flashrom</a> is a handy program to read/write to flash chips and sometimes supports talking directly to the NIC without a programmer, but listing the supported devices does not show support for our RTL8168 chip unfortunately.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>└─# flashrom -L | grep RTL
</span></span><span style="display:flex;"><span>Realtek RTL8139/8139C/8139C+  10ec:8139  OK
</span></span><span style="display:flex;"><span>Realtek RTL8169               10ec:8169  Untested
</span></span></code></pre></div><p>Looks like we&rsquo;ll have to try and read this via the hardware route. A SOIC-8 Clip is handy to do this as you can just &ldquo;clip&rdquo; on to the chip instead of having to solder anything.</p>
<p><img src="/clip-on-flash-chip-tenda.webp" alt="Clip on flash chip"></p>
<p>I wrote up some code for an Arduino to talk SPI to the chip and start reading the flash, but for some odd reason it did not want to work. After double-checking the connections, I decided to use a logical analyzer and use PulseView to see what was going on&hellip;</p>
<p><img src="/SPI-noise.webp" alt="SPI noise"></p>
<p>Without sending any SPI commands, the moment the chip was powered up from my Arduino, it appears as if the RTL8168 chip got powered up as well and started talking to the flash chip, colliding with my attempts to talk to the flash chip via my Arduino. Clearly this was not going to work so it is time to desolder the chip so we can talk to it on its own.</p>
<p>After removing the chip, it was a good time to confirm the datasheet and my wiring was correct by putting a strong light under the PCB and examining the traces.</p>
<p><img src="/pcb_examination.webp" alt="PCB"></p>
<p><img src="/tenda_flash_chip_pinout.webp" alt="flash chip pinout"></p>
<p>We can determine the GND pin by looking at the ground plane it is attached to and by testing continuity with a multimeter between it and the GND pin of the PCI card. VCC is confirmed by also checking continuity to the PCI VCC pin. Spot checking the others, CS routes to the RTL8168 chip as it should. Datasheet looks correct!</p>
<p>I didn&rsquo;t have a flash chip reader (like the CH341A) handy, so I wrote a simple Arduino program to talk SPI to the chip and read it. Going off the datasheet again, it seems like the format is:</p>
<ol>
<li>Bring CS (chip select) LOW</li>
<li>Issue read command over SPI, CMD = 0x3</li>
<li>Issue 24-bit address over SPI</li>
<li>Read data from SPI that the chip sends</li>
<li>Bring CS HIGH</li>
</ol>
<p><a href="https://www.14core.com/wiring-the-winbond-w25qxx-spi-serial-flash-memory-with-microcontroller/">More info here</a></p>
<p><img src="/flash_read_timing.webp" alt="read"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SPI.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">read_page</span>(word page_num) {
</span></span><span style="display:flex;"><span>  byte buf[<span style="color:#ae81ff">512</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, LOW);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0x3</span>); <span style="color:#75715e">// Read command
</span></span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>((page_num <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>((page_num <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    buf[i] <span style="color:#f92672">=</span> SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, HIGH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (buf[i] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>) {
</span></span><span style="display:flex;"><span>      Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;0&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Serial.<span style="color:#a6e22e">print</span>(buf[i], HEX); 
</span></span><span style="display:flex;"><span>    Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dump_rom</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1024</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">read_page</span>(i);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">delay</span>(<span style="color:#ae81ff">5000</span>);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">begin</span>(<span style="color:#ae81ff">115200</span>);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Starting...&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pinMode</span>(WP, OUTPUT);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pinMode</span>(CS, OUTPUT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(WP, HIGH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">begin</span>(CLK, DO, DI, CS);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">setDataMode</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">dump_rom</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I wrote a simple Python script to take the serial output from the Arduino and dump it to binary file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> serialtube(port<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/dev/ttyUSB0&#39;</span>, baudrate<span style="color:#f92672">=</span><span style="color:#ae81ff">115200</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dta <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>dta <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>parsed <span style="color:#f92672">=</span> dta<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>parsed <span style="color:#f92672">=</span> parsed<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39; &#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>binary <span style="color:#f92672">=</span> unhex(parsed)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#39;/tmp/dump.bin&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>)
</span></span><span style="display:flex;"><span>f<span style="color:#f92672">.</span>write(binary)
</span></span><span style="display:flex;"><span>f<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p>Looking at the dumped flash, we can clearly see this is the PXE OPROM as OPROMs start with 0x55AA in the header and we can see the common string shown during BIOS boot for PXE booting: &ldquo;Intel UNDI PXE&rdquo;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>└─$ xxd flashdump.bin 
</span></span><span style="display:flex;"><span>00000000: 55aa 14e8 ec0f cb61 bc01 <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  U......a........
</span></span><span style="display:flex;"><span>00000010: <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">2000</span> <span style="color:#ae81ff">4000</span> <span style="color:#ae81ff">6000</span> 8d64 <span style="color:#ae81ff">2400</span>  ...... .@.<span style="color:#e6db74">`</span>..d$.
</span></span><span style="display:flex;"><span>00000020: 554e <span style="color:#ae81ff">4449</span> 166b <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0102</span> a70c <span style="color:#ae81ff">0008</span> b0c4  UNDI.k..........
</span></span><span style="display:flex;"><span>00000030: b43b <span style="color:#ae81ff">5043</span> <span style="color:#ae81ff">4952</span> 8da4 <span style="color:#ae81ff">2400</span> <span style="color:#ae81ff">0000</span> 008d <span style="color:#ae81ff">4900</span>  .;PCIR..$.....I.
</span></span><span style="display:flex;"><span>00000040: <span style="color:#ae81ff">5043</span> <span style="color:#ae81ff">4952</span> ec10 <span style="color:#ae81ff">6881</span> <span style="color:#ae81ff">0000</span> 1c00 <span style="color:#ae81ff">0302</span> <span style="color:#ae81ff">0000</span>  PCIR..h.........
</span></span><span style="display:flex;"><span>00000050: <span style="color:#ae81ff">1400</span> <span style="color:#ae81ff">0102</span> <span style="color:#ae81ff">0080</span> <span style="color:#ae81ff">0800</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">3681</span> <span style="color:#ae81ff">0000</span>  ............6...
</span></span><span style="display:flex;"><span>00000060: <span style="color:#ae81ff">2450</span> 6e50 <span style="color:#ae81ff">0102</span> <span style="color:#ae81ff">0000</span> 00c0 <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> af00  $PnP............
</span></span><span style="display:flex;"><span>00000070: <span style="color:#ae81ff">9201</span> <span style="color:#ae81ff">0200</span> 00e4 <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span> d80b <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  ................
</span></span><span style="display:flex;"><span>00000080: 0d0a 436f <span style="color:#ae81ff">7079</span> <span style="color:#ae81ff">7269</span> <span style="color:#ae81ff">6768</span> <span style="color:#ae81ff">7420</span> <span style="color:#ae81ff">2843</span> <span style="color:#ae81ff">2920</span>  ..Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>00000090: <span style="color:#ae81ff">3139</span> <span style="color:#ae81ff">3937</span> 2d32 <span style="color:#ae81ff">3030</span> <span style="color:#ae81ff">3020</span> <span style="color:#ae81ff">2049</span> 6e74 656c  1997-2000  Intel
</span></span><span style="display:flex;"><span>000000a0: <span style="color:#ae81ff">2043</span> 6f72 706f <span style="color:#ae81ff">7261</span> <span style="color:#ae81ff">7469</span> 6f6e 0d0a <span style="color:#ae81ff">0049</span>   Corporation...I
</span></span><span style="display:flex;"><span>000000b0: 6e74 656c <span style="color:#ae81ff">2043</span> 6f72 706f <span style="color:#ae81ff">7261</span> <span style="color:#ae81ff">7469</span> 6f6e  ntel Corporation
</span></span><span style="display:flex;"><span>000000c0: <span style="color:#ae81ff">0049</span> 6e74 656c <span style="color:#ae81ff">2055</span> 4e44 492c <span style="color:#ae81ff">2050</span> <span style="color:#ae81ff">5845</span>  .Intel UNDI, PXE
</span></span><span style="display:flex;"><span>000000d0: 2d32 2e31 <span style="color:#ae81ff">2028</span> <span style="color:#ae81ff">6275</span> 696c <span style="color:#ae81ff">6420</span> <span style="color:#ae81ff">3038</span> <span style="color:#ae81ff">3329</span>  -2.1 <span style="color:#f92672">(</span>build 083<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>000000e0: 000d 0a54 <span style="color:#ae81ff">6869</span> <span style="color:#ae81ff">7320</span> <span style="color:#ae81ff">5072</span> 6f64 <span style="color:#ae81ff">7563</span> <span style="color:#ae81ff">7420</span>  ...This Product 
</span></span><span style="display:flex;"><span>000000f0: <span style="color:#ae81ff">6973</span> <span style="color:#ae81ff">2063</span> 6f76 <span style="color:#ae81ff">6572</span> <span style="color:#ae81ff">6564</span> <span style="color:#ae81ff">2062</span> <span style="color:#ae81ff">7920</span> 6f6e  is covered by on
</span></span><span style="display:flex;"><span>00000100: <span style="color:#ae81ff">6520</span> 6f72 206d 6f72 <span style="color:#ae81ff">6520</span> 6f66 <span style="color:#ae81ff">2074</span> <span style="color:#ae81ff">6865</span>  e or more of the
</span></span><span style="display:flex;"><span>00000110: <span style="color:#ae81ff">2066</span> 6f6c 6c6f <span style="color:#ae81ff">7769</span> 6e67 <span style="color:#ae81ff">2070</span> <span style="color:#ae81ff">6174</span> 656e   following paten
</span></span><span style="display:flex;"><span>00000120: <span style="color:#ae81ff">7473</span> 3a20 200d 0a00 <span style="color:#ae81ff">5553</span> 362c <span style="color:#ae81ff">3537</span> 302c  ts:  ...US6,570,
</span></span><span style="display:flex;"><span>00000130: <span style="color:#ae81ff">3838</span> 342c <span style="color:#ae81ff">2055</span> <span style="color:#ae81ff">5336</span> 2c31 <span style="color:#ae81ff">3135</span> 2c37 <span style="color:#ae81ff">3736</span>  884, US6,115,776
</span></span><span style="display:flex;"><span>00000140: <span style="color:#ae81ff">2061</span> 6e64 <span style="color:#ae81ff">2055</span> <span style="color:#ae81ff">5336</span> 2c33 <span style="color:#ae81ff">3237</span> 2c36 <span style="color:#ae81ff">3235</span>   and US6,327,625
</span></span><span style="display:flex;"><span>00000150: 0d0a 000d 0a52 <span style="color:#ae81ff">6561</span> 6c74 656b <span style="color:#ae81ff">2050</span> <span style="color:#ae81ff">4349</span>  .....Realtek PCI
</span></span><span style="display:flex;"><span>00000160: <span style="color:#ae81ff">6520</span> <span style="color:#ae81ff">4742</span> <span style="color:#ae81ff">4520</span> <span style="color:#ae81ff">4661</span> 6d69 6c79 <span style="color:#ae81ff">2043</span> 6f6e  e GBE Family Con
</span></span><span style="display:flex;"><span>00000170: <span style="color:#ae81ff">7472</span> 6f6c 6c65 <span style="color:#ae81ff">7220</span> <span style="color:#ae81ff">5365</span> <span style="color:#ae81ff">7269</span> <span style="color:#ae81ff">6573</span> <span style="color:#ae81ff">2076</span>  troller Series v
</span></span><span style="display:flex;"><span>00000180: 322e <span style="color:#ae81ff">3536</span> <span style="color:#ae81ff">2028</span> <span style="color:#ae81ff">3037</span> 2f30 312f <span style="color:#ae81ff">3133</span> 290d  2.56 <span style="color:#f92672">(</span>07/01/13<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>00000190: 0a00 <span style="color:#ae81ff">5265</span> 616c <span style="color:#ae81ff">7465</span> 6b20 <span style="color:#ae81ff">5058</span> <span style="color:#ae81ff">4520</span> <span style="color:#ae81ff">4230</span>  ..Realtek PXE B0
</span></span><span style="display:flex;"><span>000001a0: <span style="color:#ae81ff">3020</span> <span style="color:#ae81ff">4430</span> <span style="color:#ae81ff">3000</span> 8bff f2e6 00f0 <span style="color:#ae81ff">0000</span> <span style="color:#ae81ff">0000</span>  <span style="color:#ae81ff">0</span> D00...........
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>Now, can we replace this with iPXE? :)</p>
<h2 id="building-ipxe">Building iPXE</h2>
<p>For the OPROM to be valid, we need to set the PCI VID and PID correctly which can be obtained with <code>lspci</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>└─$ lspci -nn | grep Realtek
</span></span><span style="display:flex;"><span>03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller <span style="color:#f92672">[</span>10ec:8168<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>rev 06<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>I added some features by modifying <code>config/general.h</code> to add HTTPS, iSCSI, VLAN, ICMP, and NTP features and then built iPXE with <code>make bin/10ec8168</code>. (the 10ec8168 part comes from the lspci command above with the VID/PID).</p>
<h2 id="flashing-ipxe">Flashing iPXE</h2>
<p>Some extra code is necessary to be able to <em>write</em> to the flash chip. Add the iPXE OPROM as a C byte array by running <code>xxd -i bin/10ec8168.rom</code> which we can then use in our C code to write each byte out to the flash chip.</p>
<p>To write, we need to:</p>
<ol>
<li>Enable write, CMD = 0x6</li>
<li>Erase the region, CMD = 0xC7</li>
<li>Enable Write, CMD = 0x6</li>
<li>Send page program, CMD = 0x2</li>
<li>Send 24-bit address</li>
<li>Send page data</li>
<li>Check write status register, CMD = 0x5, check bit 1</li>
<li>Loop</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> bin_10ec8168_rom[] <span style="color:#f92672">=</span> {...};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> bin_10ec8168_rom_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">98304</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">chip_erase</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, LOW);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0x6</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, HIGH);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, LOW);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0xc7</span>); <span style="color:#75715e">// Erase
</span></span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, HIGH);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write_page</span>(word page_num, byte <span style="color:#f92672">*</span>buf) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">chk_write_status</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, LOW);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0x6</span>); <span style="color:#75715e">// Must do write enable before any write/erase
</span></span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, HIGH);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">delayMicroseconds</span>(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, LOW);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0x2</span>); <span style="color:#75715e">// Page program
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Convert to 24-bit address
</span></span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>((page_num <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>((page_num <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFF</span>);
</span></span><span style="display:flex;"><span>  SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    SPI.<span style="color:#a6e22e">transfer</span>(buf[i]);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">digitalWrite</span>(CS, HIGH);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">chk_write_status</span>() {
</span></span><span style="display:flex;"><span>  byte res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xff</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (res <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">delay</span>(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">digitalWrite</span>(CS, LOW);
</span></span><span style="display:flex;"><span>    SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0x5</span>);
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> SPI.<span style="color:#a6e22e">transfer</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">digitalWrite</span>(CS, HIGH);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flash_ipxe</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">chip_erase</span>();
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;Writing page: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> bin_10ec8168_rom_len<span style="color:#f92672">/</span><span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    byte buf[<span style="color:#ae81ff">256</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      buf[j] <span style="color:#f92672">=</span> bin_10ec8168_rom[i<span style="color:#f92672">*</span><span style="color:#ae81ff">256</span> <span style="color:#f92672">+</span> j];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Serial.<span style="color:#a6e22e">print</span>(i);
</span></span><span style="display:flex;"><span>    Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">write_page</span>(i, buf);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Done!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Success! And you can dump the flash with the previous program and compare the hash to the built iPXE ROM to confirm it was successful.</p>
<h2 id="testing-the-card">Testing the card</h2>
<p>After resoldering the flash chip to the NIC and putting it back into the PC, I tried to boot it up and select the &ldquo;Realtek Boot Agent&rdquo; option from the BIOS menu and expected iPXE to run, but it did not - I was greeted with the old OPROM that we dumped in the beginning that should have been overwritten. How?</p>
<p><img src="/old-pxerom.webp" alt="old PXE rom"></p>
<h2 id="back-to-the-eeprom">Back to the EEPROM</h2>
<p>Looking at the RTL8168 datasheet, there is some interesting information exposed via the registers (which is used during boot by the BIOS to find OPROMs). The 32-bit register at 0x30 is the <code>BMAR</code> register which contains the OPROM base address (<code>BMAR</code>) + the ROM size (<code>ROMSIZE</code>) and if it is enabled (<code>BROMEN</code>). Let&rsquo;s have a look at the values&hellip;</p>
<p><img src="/pci-registers-bootrom.webp" alt="pci registers bootrom"></p>
<p><img src="/romsize_register.webp" alt="pci romsize register"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>┌──<span style="color:#f92672">(</span>gfoudree㉿nzxt-desktop<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/tmp/r8168-8.052.01<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└─$ setpci -s 06:00.0 0x30.B 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>┌──<span style="color:#f92672">(</span>gfoudree㉿nzxt-desktop<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/tmp/r8168-8.052.01<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└─$ setpci -s 06:00.0 0x31.B
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>┌──<span style="color:#f92672">(</span>gfoudree㉿nzxt-desktop<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/tmp/r8168-8.052.01<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└─$ setpci -s 06:00.0 0x32.B
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>┌──<span style="color:#f92672">(</span>gfoudree㉿nzxt-desktop<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/tmp/r8168-8.052.01<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└─$ setpci -s 06:00.0 0x33.B
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">97</span>
</span></span></code></pre></div><p>So the <code>BMAR</code> register reads as <code>0x97100000</code> which seems okay, but the <code>ROMSIZE</code> and <code>BROMEN</code> registers are 0 which means it is disabled! No wonder iPXE isn&rsquo;t working&hellip;</p>
<p>Going back to the EEPROM I dumped earlier, there was a <code>CONFIG0</code> register which contained configuration values for the RTL8168 chip. Looking at the datasheet further, we can see there&rsquo;s 3 bits which configure the size of the boot rom located inside the byte at 0x51.</p>
<p><img src="/eeprom-config-registers.webp" alt="eeprom registers"></p>
<p><img src="/config0-eeprom-register.webp" alt="config0"></p>
<p>If you look back up where the EEPROM was dumped, you can see the value for this byte at 0x51 is 0x00 which means it is configured as &ldquo;No Boot ROM&rdquo; which concurs with values read from the PCI registers. Perhaps there is a correlation here.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0x0050:		<span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> ac 6b <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">80</span> 8d <span style="color:#ae81ff">75</span> 7b <span style="color:#ae81ff">01</span> a9 c0 <span style="color:#ae81ff">48</span> <span style="color:#ae81ff">00</span> 
</span></span></code></pre></div><p>Since we know the size of the Boot ROM (128K), the value <em>should</em> be BS2 = 1, BS1 = 0, BS0 = 1 or the whole register (CONFIG0) set to 0x5. Let&rsquo;s see if we can try and set it with ethtool&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>┌──<span style="color:#f92672">(</span>gfoudree㉿nzxt-desktop<span style="color:#f92672">)</span>-<span style="color:#f92672">[</span>/tmp/r8168-8.052.01<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>└─$ sudo ethtool -E enp6s0 offset 0x51 length <span style="color:#ae81ff">1</span> value 0x5
</span></span><span style="display:flex;"><span>Cannot set EEPROM data: Operation not supported
</span></span></code></pre></div><p>Sometimes there&rsquo;s a &ldquo;magic&rdquo; value that the driver checks as a parameter from ethtool to guard against accidental writes <a href="https://blog.kanbach.org/post/how-to-permanently-change-a-mac-address-using-ethtool/">source</a> which you pass via the <code>magic</code> parameter to ethtool. I tried many different values (0xdeadbeef, 0x0badbeef, etc) looking through the driver source and trying things from there, but none worked. I suppose we will have to write to it with hardware just like the flash chip&hellip;</p>
<h2 id="flashing-the-eeprom">Flashing the EEPROM</h2>
<p>Unfortunately, unlike the flash chip which used SPI, the EEPROM uses the MICROWIRE protocol which takes some extra work to get going. Thankfully someone <a href="https://github.com/0xJoey/Arduino_93C46">wrote a library</a> to do this, although I was successful in bitbanging the protocol going off the timing diagrams from the datasheet.</p>
<p>For some reason, the bytes were swapped so I wrote 0x5 to the address 0x50.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;93C46.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define pCS 37
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pSK 38
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pDI 39
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pDO 40
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> longMode <span style="color:#f92672">=</span> EEPROM_93C46_MODE_8BIT;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  eeprom_93C46 e <span style="color:#f92672">=</span> <span style="color:#a6e22e">eeprom_93C46</span>(pCS, pSK, pDI, pDO);
</span></span><span style="display:flex;"><span>  e.<span style="color:#a6e22e">set_mode</span>(longMode);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">begin</span>(<span style="color:#ae81ff">115200</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> longMode <span style="color:#f92672">?</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">128</span>;
</span></span><span style="display:flex;"><span>  word readBuffer[len];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> len; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read by address
</span></span></span><span style="display:flex;"><span>    word r <span style="color:#f92672">=</span> e.<span style="color:#a6e22e">read</span>(i);
</span></span><span style="display:flex;"><span>    readBuffer[i] <span style="color:#f92672">=</span> r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    byte b1 <span style="color:#f92672">=</span> r <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (b1 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>) {
</span></span><span style="display:flex;"><span>      Serial.<span style="color:#a6e22e">print</span>(<span style="color:#ae81ff">0</span>, HEX);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Serial.<span style="color:#a6e22e">print</span>(b1, HEX);
</span></span><span style="display:flex;"><span>    Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">println</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  word config <span style="color:#f92672">=</span> e.<span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0x50</span>);
</span></span><span style="display:flex;"><span>  byte b1 <span style="color:#f92672">=</span> (config <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>);
</span></span><span style="display:flex;"><span>  byte b2 <span style="color:#f92672">=</span> e.<span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0x51</span>);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(b1, HEX);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(b2, HEX);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">println</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  e.<span style="color:#a6e22e">ew_enable</span>();
</span></span><span style="display:flex;"><span>  e.<span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">0x51</span>, <span style="color:#ae81ff">0x01</span>);
</span></span><span style="display:flex;"><span>  e.<span style="color:#a6e22e">write</span>(<span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x05</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  config <span style="color:#f92672">=</span> e.<span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0x50</span>);
</span></span><span style="display:flex;"><span>  b1 <span style="color:#f92672">=</span> (config <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>);
</span></span><span style="display:flex;"><span>  b2 <span style="color:#f92672">=</span> e.<span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0x51</span>);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(b1, HEX);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">print</span>(b2, HEX);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">println</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {}
</span></span></code></pre></div><h2 id="trying-again">Trying again</h2>
<p>After resoldering everything and trying to boot again, the same problem occured. Time to debug the BIOS and see why the OPROM is getting passed over.</p>
<h2 id="qemu--seabios-debugging">QEMU + Seabios Debugging</h2>
<p>Seabios is an opensource BIOS implementation which supports verbose logging during boot and even attaching with GDB while running inside of QEMU (x86 emulator). To debug the PCI card, we will need to pass it through via PCI-passthrough to the QEMU instance so that Seabios can attempt to enumerate it and run the OPROM on the card.</p>
<h2 id="enabling-pci-passthrough-on-linux">Enabling PCI-passthrough on Linux</h2>
<p>First we must enable IOMMU which allows the CPU and MMU to isolate a memory region for the VM. <a href="https://www.theseus-os.com/Theseus/book/running/virtual_machine/pci_passthrough.html">More details</a></p>
<p>I have an Intel desktop, so we must add the following to the Linux kernel cmdline in /boot/grub/grub.cfg</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>intel_iommu<span style="color:#f92672">=</span>on iommu<span style="color:#f92672">=</span>pt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example: GRUB_CMDLINE_LINUX_DEFAULT=&#34;apparmor=1 security=apparmor udev.log_priority=3 iommu=pt intel_iommu=on&#34;</span>
</span></span></code></pre></div><p>Then update grub and reboot.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span><span style="display:flex;"><span>reboot
</span></span></code></pre></div><p>Check if the IOMMU was enabled correctly (we can see the iommu groups being populated and &ldquo;IOMMU enabled&rdquo;)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>└─$ sudo dmesg | grep -i IOMMU
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.000000<span style="color:#f92672">]</span> Command line: BOOT_IMAGE<span style="color:#f92672">=</span>/boot/vmlinuz-6.8-x86_64 root<span style="color:#f92672">=</span>UUID<span style="color:#f92672">=</span>4cb39bdb-5857-459b-be4f-993bb0a40160 rw apparmor<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> security<span style="color:#f92672">=</span>apparmor udev.log_priority<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> iommu<span style="color:#f92672">=</span>pt intel_iommu<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.037633<span style="color:#f92672">]</span> Kernel command line: BOOT_IMAGE<span style="color:#f92672">=</span>/boot/vmlinuz-6.8-x86_64 root<span style="color:#f92672">=</span>UUID<span style="color:#f92672">=</span>4cb39bdb-5857-459b-be4f-993bb0a40160 rw apparmor<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> security<span style="color:#f92672">=</span>apparmor udev.log_priority<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> iommu<span style="color:#f92672">=</span>pt intel_iommu<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.037677<span style="color:#f92672">]</span> DMAR: IOMMU enabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.085607<span style="color:#f92672">]</span> DMAR-IR: IOAPIC id <span style="color:#ae81ff">2</span> under DRHD base  0xfed91000 IOMMU <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.274876<span style="color:#f92672">]</span> iommu: Default domain type: Passthrough <span style="color:#f92672">(</span>set via kernel command line<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301886<span style="color:#f92672">]</span> pci 0000:00:00.0: Adding to iommu group <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301893<span style="color:#f92672">]</span> pci 0000:00:01.0: Adding to iommu group <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301899<span style="color:#f92672">]</span> pci 0000:00:06.0: Adding to iommu group <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301904<span style="color:#f92672">]</span> pci 0000:00:0a.0: Adding to iommu group <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301909<span style="color:#f92672">]</span> pci 0000:00:0e.0: Adding to iommu group <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301919<span style="color:#f92672">]</span> pci 0000:00:14.0: Adding to iommu group <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301924<span style="color:#f92672">]</span> pci 0000:00:14.2: Adding to iommu group <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301929<span style="color:#f92672">]</span> pci 0000:00:14.3: Adding to iommu group <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301941<span style="color:#f92672">]</span> pci 0000:00:15.0: Adding to iommu group <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301945<span style="color:#f92672">]</span> pci 0000:00:15.1: Adding to iommu group <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301950<span style="color:#f92672">]</span> pci 0000:00:15.2: Adding to iommu group <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301957<span style="color:#f92672">]</span> pci 0000:00:16.0: Adding to iommu group <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301962<span style="color:#f92672">]</span> pci 0000:00:17.0: Adding to iommu group <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301970<span style="color:#f92672">]</span> pci 0000:00:1a.0: Adding to iommu group <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301978<span style="color:#f92672">]</span> pci 0000:00:1b.0: Adding to iommu group <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.301997<span style="color:#f92672">]</span> pci 0000:00:1c.0: Adding to iommu group <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302004<span style="color:#f92672">]</span> pci 0000:00:1c.1: Adding to iommu group <span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302011<span style="color:#f92672">]</span> pci 0000:00:1c.2: Adding to iommu group <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302021<span style="color:#f92672">]</span> pci 0000:00:1d.0: Adding to iommu group <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302028<span style="color:#f92672">]</span> pci 0000:00:1d.4: Adding to iommu group <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302042<span style="color:#f92672">]</span> pci 0000:00:1f.0: Adding to iommu group <span style="color:#ae81ff">17</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302048<span style="color:#f92672">]</span> pci 0000:00:1f.3: Adding to iommu group <span style="color:#ae81ff">17</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302054<span style="color:#f92672">]</span> pci 0000:00:1f.4: Adding to iommu group <span style="color:#ae81ff">17</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302060<span style="color:#f92672">]</span> pci 0000:00:1f.5: Adding to iommu group <span style="color:#ae81ff">17</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302069<span style="color:#f92672">]</span> pci 0000:01:00.0: Adding to iommu group <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302076<span style="color:#f92672">]</span> pci 0000:01:00.1: Adding to iommu group <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302081<span style="color:#f92672">]</span> pci 0000:02:00.0: Adding to iommu group <span style="color:#ae81ff">19</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302095<span style="color:#f92672">]</span> pci 0000:06:00.0: Adding to iommu group <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302102<span style="color:#f92672">]</span> pci 0000:07:00.0: Adding to iommu group <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>    0.302109<span style="color:#f92672">]</span> pci 0000:09:00.0: Adding to iommu group <span style="color:#ae81ff">22</span>
</span></span></code></pre></div><p>Then we need to identify the PCI device we want to passthrough (10ec:8168)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>└─$ lspci -vvn -s 06:00.0                                                                                                                                               <span style="color:#ae81ff">130</span> ⨯
</span></span><span style="display:flex;"><span>06:00.0 0200: 10ec:8168 <span style="color:#f92672">(</span>rev 06<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	Subsystem: 10ec:0123
</span></span><span style="display:flex;"><span>	Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx-
</span></span><span style="display:flex;"><span>	Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL<span style="color:#f92672">=</span>fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-
</span></span><span style="display:flex;"><span>	Interrupt: pin A routed to IRQ <span style="color:#ae81ff">17</span>
</span></span><span style="display:flex;"><span>	IOMMU group: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>	Region 0: I/O ports at <span style="color:#ae81ff">5000</span> <span style="color:#f92672">[</span>size<span style="color:#f92672">=</span>256<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Region 2: Memory at <span style="color:#ae81ff">97120000</span> <span style="color:#f92672">(</span>64-bit, non-prefetchable<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>size<span style="color:#f92672">=</span>4K<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Region 4: Memory at <span style="color:#ae81ff">4004100000</span> <span style="color:#f92672">(</span>64-bit, prefetchable<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>size<span style="color:#f92672">=</span>16K<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Expansion ROM at <span style="color:#ae81ff">97100000</span> <span style="color:#f92672">[</span>disabled<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>size<span style="color:#f92672">=</span>128K<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	Capabilities: &lt;access denied&gt;
</span></span><span style="display:flex;"><span>	Kernel driver in use: r8169
</span></span><span style="display:flex;"><span>	Kernel modules: r8169
</span></span></code></pre></div><p>Here we can see that the OPROM is enumerated but marked as disabled. Also, r8169 is the current driver in use which we need to unbind so that we can use VFIO to pass it to QEMU.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Add device to VFIO so it grabs it</span>
</span></span><span style="display:flex;"><span>echo 10ec <span style="color:#ae81ff">8168</span> &gt; /sys/bus/pci/drivers/vfio-pci/new_id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Unbind device from current driver</span>
</span></span><span style="display:flex;"><span>echo 0000:06:00.0 &gt; /sys/bus/pci/drivers/r8169/unbind
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install VFIO module</span>
</span></span><span style="display:flex;"><span>modprobe vfio_pci ids<span style="color:#f92672">=</span>10ec:8168
</span></span></code></pre></div><p>Check that it worked&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>└─$ ls /dev/vfio 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">20</span>  devices  vfio
</span></span></code></pre></div><p>Great!</p>
<h2 id="building-seabios">Building Seabios</h2>
<p>We want to make a verbose debugging build of Seabios by setting the level to 8, and also enabling the special debug IO port which allows QEMU to get the debug info from Seabios at runtime.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/qemu/seabios.git
</span></span><span style="display:flex;"><span>make menuconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set Debugging -&gt; Debug Level = 8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Debugging -&gt; Special IO port debugging = True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make -j
</span></span></code></pre></div><h2 id="running-it-all">Running it all</h2>
<p>Pass in the <code>bios.bin</code> file from the Seabios build along with the PCI device information <code>06:00.0</code> and be sure to disable the standard NIC QEMU automatically adds with <code>-net none</code>. The <code>-device isa-debugcon,iobase=0x402,chardev=seabios</code> command is what accesses the debug IO port Seabios sends messages to so we can see them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo qemu-system-x86_64 -m <span style="color:#ae81ff">128</span> -bios out/bios.bin -chardev stdio,id<span style="color:#f92672">=</span>seabios <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>-device isa-debugcon,iobase<span style="color:#f92672">=</span>0x402,chardev<span style="color:#f92672">=</span>seabios -net none -device vfio-pci,host<span style="color:#f92672">=</span>06:00.0 -enable-kvm
</span></span></code></pre></div><p>Looking at the debug logs from QEMU, we can see that Seabios finds the OPROM and executes it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Attempting to init PCI bdf 00:03.0 <span style="color:#f92672">(</span>vd 10ec:8168<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Attempting to map option rom on dev 00:03.0
</span></span><span style="display:flex;"><span>Option rom sizing returned febc0000 fffe0000
</span></span><span style="display:flex;"><span>Inspecting possible rom at 0xfebc0000 <span style="color:#f92672">(</span>vd<span style="color:#f92672">=</span>10ec:8168 bdf<span style="color:#f92672">=</span>00:03.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Copying option rom <span style="color:#f92672">(</span>size 98304<span style="color:#f92672">)</span> from 0xfebc0000 to 0x000c9000
</span></span><span style="display:flex;"><span>Checking rom 0x000c9000 <span style="color:#f92672">(</span>sig aa55 size 192<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Running option rom at c900:0003
</span></span></code></pre></div><p><strong>Success!!</strong></p>
<p><img src="/qemu_ipxe_boot.webp" alt="success"></p>
<h2 id="trying-with-uefi">Trying with UEFI</h2>
<p>QEMU can also run with UEFI instead of a legacy BIOS. Tianocore OVMF is great for this and instructions to build it can be found <a href="https://github.com/tianocore/tianocore.github.io/wiki/How-to-build-OVMF">here</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/tianocore/edk2.git
</span></span><span style="display:flex;"><span>cd edk2
</span></span><span style="display:flex;"><span>git submodule update --init
</span></span><span style="display:flex;"><span>make -C BaseTools -j
</span></span><span style="display:flex;"><span>source edksetup.sh
</span></span><span style="display:flex;"><span>cd ../
</span></span><span style="display:flex;"><span>make -C edk2/BaseTools
</span></span></code></pre></div><p>Add the following to <code>edk2/Conf/target.txt</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>TARGET                <span style="color:#f92672">=</span> DEBUG
</span></span><span style="display:flex;"><span>TARGET_ARCH           <span style="color:#f92672">=</span> X64
</span></span><span style="display:flex;"><span>TOOL_CHAIN_TAG        <span style="color:#f92672">=</span> GCC5
</span></span></code></pre></div><p>Then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>build -p OvmfPkg/OvmfPkgX64.dsc
</span></span><span style="display:flex;"><span>sudo qemu-system-x86_64 -bios /tmp/edk2/Build/OvmfX64/DEBUG_GCC5/FV/OVMF.fd -net none <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span> -debugcon file:debug.log -global isa-debugcon.iobase<span style="color:#f92672">=</span>0x402 -device vfio-pci,host<span style="color:#f92672">=</span>06:00.0
</span></span></code></pre></div><p>Looking at the video output, the iPXE OPROM does not run (just like in the physical computer). This is confirmed by the debug logs which shows it &ldquo;processes&rdquo; OPROM and shows it as being present, but nothing else in the log indicates that it runs it or attempts to do so. Strange.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Process Option ROM: BAR Base/Length <span style="color:#f92672">=</span> 81000000/20000
</span></span><span style="display:flex;"><span>PciBus: Resource Map <span style="color:#66d9ef">for</span> Root Bridge PciRoot<span style="color:#f92672">(</span>0x0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Type <span style="color:#f92672">=</span>   Io16; Base <span style="color:#f92672">=</span> 0xC000;	Length <span style="color:#f92672">=</span> 0x1000;	Alignment <span style="color:#f92672">=</span> 0xFFF
</span></span><span style="display:flex;"><span>   Base <span style="color:#f92672">=</span> 0xC000;	Length <span style="color:#f92672">=</span> 0x100;	Alignment <span style="color:#f92672">=</span> 0xFF;	Owner <span style="color:#f92672">=</span> PCI <span style="color:#f92672">[</span>00|03|00:10<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>   Base <span style="color:#f92672">=</span> 0xC100;	Length <span style="color:#f92672">=</span> 0x10;	Alignment <span style="color:#f92672">=</span> 0xF;	Owner <span style="color:#f92672">=</span> PCI <span style="color:#f92672">[</span>00|01|01:20<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Type <span style="color:#f92672">=</span>  Mem32; Base <span style="color:#f92672">=</span> 0x80000000;	Length <span style="color:#f92672">=</span> 0x1100000;	Alignment <span style="color:#f92672">=</span> 0xFFFFFF
</span></span><span style="display:flex;"><span>   Base <span style="color:#f92672">=</span> 0x80000000;	Length <span style="color:#f92672">=</span> 0x1000000;	Alignment <span style="color:#f92672">=</span> 0xFFFFFF;	Owner <span style="color:#f92672">=</span> PCI <span style="color:#f92672">[</span>00|02|00:10<span style="color:#f92672">]</span>; Type <span style="color:#f92672">=</span> PMem32
</span></span><span style="display:flex;"><span>   Base <span style="color:#f92672">=</span> 0x81000000;	Length <span style="color:#f92672">=</span> 0x20000;	Alignment <span style="color:#f92672">=</span> 0x1FFFF;	Owner <span style="color:#f92672">=</span> PCI <span style="color:#f92672">[</span>00|00|00:00<span style="color:#f92672">]</span>; Type <span style="color:#f92672">=</span>  OpRom
</span></span><span style="display:flex;"><span>   Base <span style="color:#f92672">=</span> 0x81020000;	Length <span style="color:#f92672">=</span> 0x1000;	Alignment <span style="color:#f92672">=</span> 0xFFF;	Owner <span style="color:#f92672">=</span> PCI <span style="color:#f92672">[</span>00|02|00:18<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Type <span style="color:#f92672">=</span>  Mem64; Base <span style="color:#f92672">=</span> 0xC000000000;	Length <span style="color:#f92672">=</span> 0x100000;	Alignment <span style="color:#f92672">=</span> 0xFFFFF
</span></span><span style="display:flex;"><span>   Base <span style="color:#f92672">=</span> 0xC000000000;	Length <span style="color:#f92672">=</span> 0x4000;	Alignment <span style="color:#f92672">=</span> 0x3FFF;	Owner <span style="color:#f92672">=</span> PCI <span style="color:#f92672">[</span>00|03|00:20<span style="color:#f92672">]</span>; Type <span style="color:#f92672">=</span> PMem64
</span></span><span style="display:flex;"><span>   Base <span style="color:#f92672">=</span> 0xC000004000;	Length <span style="color:#f92672">=</span> 0x1000;	Alignment <span style="color:#f92672">=</span> 0xFFF;	Owner <span style="color:#f92672">=</span> PCI <span style="color:#f92672">[</span>00|03|00:18<span style="color:#f92672">]</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>I am not 100% sure, but my guess is that the PC I originally ran the card on was a modern UEFI system which did not support running the older OPROM or there was some sort of misconfiguration going on. It doesn&rsquo;t explain why the original OPROM <em>did</em> run, however. I remain somewhat puzzled, but happy that the flashed iPXE ROM does finally run.</p>

    </article>

    
    
    <div class="pagination" style="margin-top:3rem;">
      <a href="http://localhost:51372/post/securing-sites-with-hardware-mtls-and-yubikeys/">← Securing Sites With Hardware MTLS and Yubikeys</a>
      <a href="http://localhost:51372/post/sierra-wireless-em7455-4g-modem-hacking/">Sierra Wireless EM7455 4G Modem Hacking →</a>
    </div>
    
  </div>

</div>

  </main><footer class="site-footer">
  <div class="container">
    <div class="footer-left">
      <strong>x86sec</strong> — a cybersecurity blog<br>
      &copy; 2026 Grant Foudree
    </div>
    <div class="footer-links">
      <a href="https://github.com/gfoudree" rel="noopener">github</a>
    </div>
  </div>
</footer>
<script src="/js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
